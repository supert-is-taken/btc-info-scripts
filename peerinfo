#!/usr/bin/env bash

# (c) /u/supert 2016
# release under MIT licence

# requires geoip-bin package to be installed
test -z $(which geoiplookup) && echo "$(basename $0) requires geiop-bin to be installed."
test -z $(which bitcoin-cli) && echo "$(basename $0) requires bitcoin-cli to be installed."
test -z $(which jq) && echo "$(basename $0) requires jq to be installed."

# test for options
HTML=
while getopts hwn: opt
do
    case "$opt" in
    (h) echo "usage: $0 [-w]";;
    (w) HTML=1;;
    esac
done

shift $((OPTIND - 1))

RANDFILE=/tmp/$RANDOM.tmp
bitcoin-cli getpeerinfo > $RANDFILE

GEOFILE=/tmp/$RANDOM.tmp
CLIENTS=/tmp/$RANDOM.tmp
STARTINGHEIGHT=/tmp/$RANDOM.tmp
SYNCED_BLOCKS=/tmp/$RANDOM.tmp
TABLE=/tmp/$RANDOM.tmp
OUTFILE=/tmp/$RANDOM.tmp

IPS=$(grep 'addr":' $RANDFILE | grep -oE '([0-9]*\.[0-9]*\.[0-9]*\.[0-9]*)')
for IP in $IPS
do
    geoiplookup $IP | sed -e 's/.*, /%/' >> $GEOFILE
done

# get relevant bits of json reply
nl <(grep 'subver' $RANDFILE | sed -e 's/ *//' -e 's/.*: \"\//%/' -e 's/\/\"//' -e 's/,//' -e 's/:/%/') > $CLIENTS
nl <(grep 'synced_blocks' $RANDFILE | sed -e 's/.*: /%/' -e 's/\/\"//' -e 's/,//') > $SYNCED_BLOCKS
nl <(grep 'startingheight' $RANDFILE | sed -e 's/.*: /%/' -e 's/\/\"//' -e 's/,//') > $STARTINGHEIGHT

# join results and present as a table
# % is column separator
(\
    echo "#%client%ver%location%startingheight%synced_blocks"; \
    echo "-%------%---%--------%--------------%-------------"; \
    join <( join $CLIENTS <( join <(nl $GEOFILE) $STARTINGHEIGHT ) ) $SYNCED_BLOCKS; \
) > $TABLE
cat $TABLE | column -t -s'%' > $OUTFILE


if [ -z $HTML ]
then
    cat $OUTFILE
    echo
    echo "local block count: " $(bitcoin-cli getblockcount)
    echo "tx in mempool: " $(bitcoin-cli getmempoolinfo | jq '.size') ", usage:" $(($(bitcoin-cli getmempoolinfo | jq '.usage') /1024/1024)) " Mb, size:" $(($(bitcoin-cli getmempoolinfo | jq '.bytes') /1024/1024)) " Mb"
else
    cat $TABLE | awk 'BEGIN{print "<table>"; FS = "%" } {print "<tr>";for(i=1;i<=NF;i++)print "<td>" $i"</td>";print "</tr>"} END{print "</table>"}'
    echo
    echo "<table>"
    echo "<td>local block count</td><td>" $(bitcoin-cli getblockcount) "</td>"
    echo "<tr><td>tx in mempool</td><td>" $(bitcoin-cli getmempoolinfo | jq '.size') "</td></tr><tr><td>usage</td><td>" $(($(bitcoin-cli getmempoolinfo | jq '.usage') /1024/1024)) "Mb</td></tr><tr><td>size<td>" $(($(bitcoin-cli getmempoolinfo | jq '.bytes') /1024/1024)) " Mb</td></tr>"
    echo "</table>"
fi


rm $TABLE
rm $GEOFILE
rm $CLIENTS
rm $SYNCED_BLOCKS
rm $STARTINGHEIGHT
rm $RANDFILE

